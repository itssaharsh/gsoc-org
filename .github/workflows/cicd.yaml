name: GSoC Viewer CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted  # MUST be self-hosted to access your WSL cluster
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    # 1. Build Docker Image
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Push
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        # UPDATE THIS TAG with your Docker Hub username
        tags: yourdockerhubuser/gsoc-viewer:latest

    # 2. Inject Secrets into Cluster
    - name: Update Cluster Secrets
      run: |
        # Create (or overwrite) the secret in the cluster using GitHub variables
        kubectl create secret generic gsoc-db-secrets \
          --from-literal=db_root_password='${{ secrets.DB_ROOT_PASSWORD }}' \
          --from-literal=db_user='${{ secrets.DB_USER }}' \
          --from-literal=db_password='${{ secrets.DB_PASSWORD }}' \
          --from-literal=db_name='${{ secrets.DB_NAME }}' \
          --dry-run=client -o yaml | kubectl apply -f -

    # 3. Deploy App
    - name: Deploy to Kubernetes
      run: |
        # Apply the infrastructure
        kubectl apply -f k8s/mysql.yaml
        kubectl apply -f k8s/app.yaml
        
        # Force restart the pod to pull the new image
        kubectl rollout restart deployment/gsoc-viewer